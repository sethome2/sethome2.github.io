<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" >

<title>Java课设——串口通讯助手 | sethome的橱窗</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://sethome2.github.io/favicon.ico?v=1655523289408">
<link rel="stylesheet" href="https://sethome2.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GGN093XZS4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GGN093XZS4');
</script>
<script>
  var _hmt = _hmt || [];
  (function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?962ffd213ed43ff588cf9a794c723d58";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-P786JZL');
</script>
<!-- End Google Tag Manager -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GGN093XZS4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GGN093XZS4');
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<!-- The loading of KaTeX is deferred to speed up page rendering -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js" integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<!-- To automatically render math in text elements, include the auto-render extension: -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>



    <meta name="description" content="之前利用Qt做过Robomaster哨兵的调试程序，因为Java课设需要，就稍微复刻一下。
Java对比CPP，具有在包管理系统相对来说更全面，我的项目采用Maven包管理系统和构建工具，但是用了比较过时的Java8 &amp; JavaF..." />
    <meta name="keywords" content="" />
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P786JZL"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <div id="app" class="main">

    <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://sethome2.github.io">
        <img src="https://sethome2.github.io/images/avatar.png?v=1655523289408" class="site-logo">
        <h1 class="site-title">sethome的橱窗</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://sethome2.github.io" class="site-nav">
            首页 / Home
          </a>
        
      
        
          <a href="https://sethome2.github.io/tag/VvCd9lSL-/" class="site-nav">
            奇怪的项目 / Project
          </a>
        
      
        
          <a href="https://sethome2.github.io/tag/T7U4S5FR5/" class="site-nav">
            照片 / Picture
          </a>
        
      
        
          <a href="https://sethome2.github.io/tags" class="site-nav">
            文章标签 / Article Tags
          </a>
        
      
        
          <a href="https://sethome2.github.io/archives" class="site-nav">
            文章列表 / Article List
          </a>
        
      
        
          <a href="https://sethome2.github.io/post/about" class="site-nav">
            关于 / About
          </a>
        
      
        
          <a href="https://sethome2.github.io/post/you-qing-lian-jie" class="site-nav" target="_blank">
            友情链接 / ExchangeLink
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/sethome2" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      sethome的橱窗
    </div>
    <div class="site-footer">
      <p>除另有声明外，图片不得商用，商业电邮</p>
<p>文章转载与引用请附上链接</p>
Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
<div target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=45012202000129" style="color:#dee2e6;"><a>桂公网安备 45012202000129号</a></div><p></p>
<a href="http://www.beian.miit.gov.cn/" style="color:#dee2e6;"> 桂ICP备2022001235号-1</a><p></p> | <a class="rss" href="https://sethome2.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">
              Java课设——串口通讯助手
            </h2>
            <div class="post-date">
              2022-06-17
            </div>
            
                <div class="post-content" v-pre>
                  <p>之前利用Qt做过Robomaster哨兵的调试程序，因为Java课设需要，就稍微复刻一下。</p>
<p>Java对比CPP，具有在包管理系统相对来说更全面，我的项目采用Maven包管理系统和构建工具，但是用了比较过时的Java8 &amp; JavaFx（这是在我初中的时候学的hhhh）</p>
<p>其他都不难，主要是Java SerialPort怎么调用JVM之外的接口呢？查询了<a href="https://mvnrepository.com/">https://mvnrepository.com/</a>里面，直接搜索SerialPort，可以找到这样的一个Jar包和项目。<br>
<a href="http://rxtx.qbang.org/">项目地址 http://rxtx.qbang.org/</a><br>
<a href="https://mvnrepository.com/artifact/">Maven库地址</a></p>
<p>超老了，但是在搜索引擎搜索较为广泛的使用也是这个包（为后续坑埋下了伏笔了属实）</p>
<p>官方标注2.2版本是一个preview,但是maven 仓库是2.1版本。。。<br>
<img src="https://sethome2.github.io/post-images/1655444725907.jpg" alt="" loading="lazy"><br>
介于该Jar包需要在JDK中复制进新的DLL文件，Jar包读取运用该DLL，对DLL的版本敏感，故在网上搜索到了2.1版本的DLL包（否则在调用Jar包中的接口时，会提示DLL版本不匹配）</p>
<p>好了已经有串口通讯的Jar包了，准备利用JavaFx SceneBuilder 构建一个新的界面，得到一个fxml文件。<br>
<img src="https://sethome2.github.io/post-images/1655445638425.jpg" alt="" loading="lazy"><br>
最上面的是接受窗口，下面是发送串口，一个用于清除接受窗口内容的按钮，两个用于选择串口及其波特率的下拉选项框。一个发送按钮构成了最基本的按钮。</p>
<p>后续打算价格按钮一键保存按钮了，奈何时间和其他事情太忙了。</p>
<p>开整，首先先构建SerialController类，用于串口控制，代码如下：</p>
<pre><code class="language-Java">import gnu.io.*;
import org.omg.PortableInterceptor.ServerRequestInfo;

import java.io.*;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.List;
import java.util.TooManyListenersException;

public class SerialController {

    private RXTXPort serialPort;

    /**
     * 获得系统可用端口的列表
     *
     * @return 可用的端口名称列表
     */
    public static List&lt;String&gt; getSystemPort() {
        List&lt;String&gt; systemPorts = new ArrayList&lt;&gt;();
        // 获得系统可用的端口
        Enumeration&lt;CommPortIdentifier&gt; portList = CommPortIdentifier.getPortIdentifiers();
        while (portList.hasMoreElements()) {
            String portName = portList.nextElement().getName();
            systemPorts.add(portName);
        }
        System.out.println(&quot;系统可用端口列表： &quot; + systemPorts);
        return systemPorts;
    }

    /**
     * 开启串口
     *
     * @param name     串口名称
     * @param baudRate 波特率
     * @return 串口对象
     */
    public boolean open(String name, int baudRate) {
        try {
            // 通过端口名称得到端口
            CommPortIdentifier portIdentifier = CommPortIdentifier.getPortIdentifier(name);
            // 打开端口 自定义名字，打开超时时间
            CommPort commPort = portIdentifier.open(name, 2222);
            // 判断是不是串口
            if (commPort instanceof SerialPort) {
                serialPort = (RXTXPort) commPort;
                // 设置串口参数（波特率，数据位8， 停止位1， 校验位无）
                serialPort.setSerialPortParams(baudRate, SerialPort.DATABITS_8, SerialPort.STOPBITS_1,
                        SerialPort.PARITY_NONE);
                return true;
            } else {
                // 是其他类型端口
                throw new NoSuchPortException();
            }
        } catch (UnsupportedCommOperationException | NoSuchPortException | PortInUseException e) {
            serialPort.close();
            e.printStackTrace();
        }
        return false;
    }

    /**
     * 关闭串口
     */
    public void close() {
        if (serialPort != null) {
            serialPort.close();
            serialPort = null;
        }
    }

    /**
     * 向串口发送数据
     *
     * @param data 发送的数据
     */
    public void sendData(String data) {
        PrintStream printStream = null;
        try {
            // printStream = new PrintStream(serialPort.getOutputStream(), true, &quot;GBK&quot;);
            // //获取串口的输出流
            // printStream.print(data);
            serialPort.getOutputStream().write(data.getBytes()); // 直接输出
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (printStream != null) {
                printStream.close();
            }
        }
    }

    /**
     * 读取串口数据
     *
     * @return 返回串口数据
     */
    public String readData() throws UnsupportedEncodingException {
        // 保存串口返回信息
        InputStream is = serialPort.getInputStream();
        byte[] bytes = null;

        try {
            synchronized (is) {
                bytes = new byte[is.available()];
                // serialPort.MonitorThreadLock = false;
                is.read(bytes, 0, is.available());
            }
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                if (is != null) {
                    is.close();
                    is = null;
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        return bytes.toString();
    }

    /**
     * 合并数组
     *
     * @param firstArray  第一个数组
     * @param secondArray 第二个数组
     * @return 合并后的数组
     */
    public static byte[] getBytes(byte[] firstArray, byte[] secondArray) {
        if (firstArray == null || secondArray == null) {
            return null;
        }
        byte[] bytes = new byte[firstArray.length + secondArray.length];
        System.arraycopy(firstArray, 0, bytes, 0, firstArray.length);
        System.arraycopy(secondArray, 0, bytes, firstArray.length, secondArray.length);
        return bytes;
    }

    /**
     * 添加串口事件监听器
     * 
     * @param listener
     */
    public void setListenerToSerialPort(SerialPortEventListener listener) {
        try {
            // 给串口添加事件监听
            serialPort.addEventListener(listener);
        } catch (TooManyListenersException e) {
            e.printStackTrace();
        }
        serialPort.notifyOnDataAvailable(true);// 串口有数据监听
        serialPort.notifyOnBreakInterrupt(true);// 中断事件监听
    }

    // 单例模式
    static SerialController object = null;
    static SerialController getSerialController()
    {
        if(object == null)
            object = new SerialController();
        return object;
    } 
}
</code></pre>
<p>里面包含了串口控制的代码，但是由于RXTXcomm是一个依赖于DLL的一个库，如果DLL不对会导致ABI不兼容，然后导致JVM虚拟机的coreDump错误。。因为实在太过久远，我也没办法找到原来的DLL代码重新编译。。。</p>
<p>导致了我的项目只能发送不能接收，如果通过Java 反汇编代码发现是自旋锁不解锁导致的。。。我也尝试下载Jar包的源码修改，将自旋锁转换为乐观锁。。。但是会直接崩溃。。。</p>
<p>接下来介绍一下JavaFx GUI界面的部分吧。</p>
<p>JavaFx是利用FXML文件和JavaFx SceneBuilder 构建的<br>
具体如下，包括两个文本框用于接受和发送。</p>
<pre><code class="language-XML">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;?import javafx.scene.text.*?&gt;
&lt;?import java.lang.*?&gt;
&lt;?import javafx.scene.control.*?&gt;
&lt;?import javafx.scene.layout.*?&gt;

&lt;AnchorPane id=&quot;Baud&quot; fx:id=&quot;anchorage&quot; maxHeight=&quot;-Infinity&quot; maxWidth=&quot;-Infinity&quot; minHeight=&quot;-Infinity&quot; minWidth=&quot;-Infinity&quot; prefHeight=&quot;525.0&quot; prefWidth=&quot;675.0&quot; xmlns=&quot;http://javafx.com/javafx/8&quot; xmlns:fx=&quot;http://javafx.com/fxml/1&quot; fx:controller=&quot;SerialAssistant&quot;&gt;
    &lt;children&gt;
        &lt;TextArea fx:id=&quot;receiveText&quot; layoutX=&quot;15.0&quot; layoutY=&quot;14.0&quot; prefHeight=&quot;285.0&quot; prefWidth=&quot;643.0&quot; /&gt;
        &lt;TextArea fx:id=&quot;sendText&quot; layoutX=&quot;14.0&quot; layoutY=&quot;312.0&quot; prefHeight=&quot;162.0&quot; prefWidth=&quot;487.0&quot; /&gt;
        &lt;Button fx:id=&quot;clear&quot; layoutX=&quot;516.0&quot; layoutY=&quot;312.0&quot; mnemonicParsing=&quot;false&quot; onAction=&quot;#clear&quot; prefHeight=&quot;26.0&quot; prefWidth=&quot;141.0&quot; text=&quot;清除&quot; /&gt;
        &lt;ComboBox fx:id=&quot;comboBox&quot; layoutX=&quot;516.0&quot; layoutY=&quot;345.0&quot; onShown=&quot;#onShowComboBox&quot; prefHeight=&quot;26.0&quot; prefWidth=&quot;141.0&quot; /&gt;
        &lt;ComboBox fx:id=&quot;BaudRateBox&quot; layoutX=&quot;516.0&quot; layoutY=&quot;380.0&quot; onShown=&quot;#onShowBaudRateBox&quot; prefHeight=&quot;26.0&quot; prefWidth=&quot;141.0&quot; /&gt;
        &lt;Button fx:id=&quot;openBnt&quot; layoutX=&quot;516.0&quot; layoutY=&quot;414.0&quot; mnemonicParsing=&quot;false&quot; onAction=&quot;#onActionOpenBtn&quot; prefHeight=&quot;26.0&quot; prefWidth=&quot;141.0&quot; text=&quot;打开串口&quot; /&gt;
        &lt;Button fx:id=&quot;sendBnt&quot; layoutX=&quot;516.0&quot; layoutY=&quot;448.0&quot; mnemonicParsing=&quot;false&quot; onAction=&quot;#onActionSendBtn&quot; prefHeight=&quot;26.0&quot; prefWidth=&quot;141.0&quot; text=&quot;发送&quot; /&gt;
      &lt;VBox prefHeight=&quot;200.0&quot; prefWidth=&quot;100.0&quot; /&gt;
      &lt;Label layoutX=&quot;21.0&quot; layoutY=&quot;487.0&quot; prefHeight=&quot;24.0&quot; prefWidth=&quot;78.0&quot; text=&quot;通信统计:&quot; /&gt;
      &lt;Label fx:id=&quot;cnt&quot; layoutX=&quot;100.0&quot; layoutY=&quot;487.0&quot; prefHeight=&quot;24.0&quot; prefWidth=&quot;115.0&quot; text=&quot;发送:0|接收:0&quot; /&gt;

    &lt;/children&gt;
&lt;/AnchorPane&gt;
</code></pre>
<p>按钮中绑定了事件</p>
<pre><code class="language-java">import gnu.io.SerialPortEvent;
import javafx.application.Platform;
import javafx.event.ActionEvent;
import javafx.event.Event;
import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Label;
import javafx.scene.control.TextArea;

import java.io.UnsupportedEncodingException;
import java.util.List;
import java.util.Objects;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class SerialAssistant {
    @FXML
    private TextArea receiveText;
    @FXML
    private TextArea sendText;
    @FXML
    private Button openBnt;
    @FXML
    private ComboBox&lt;String&gt; comboBox;
    @FXML
    private ComboBox&lt;Integer&gt; BaudRateBox;
    @FXML
    private Label cnt;

    public SerialController serialController;
    private List&lt;String&gt; systemPorts;
    private boolean isOpen = false;

    public SerialAssistant() {
        serialController = SerialController.getSerialController();
    }

    /**
     * 点击commbox，刷新里面的数据
     */
    public void onShowComboBox(Event event) {
        systemPorts = SerialController.getSystemPort();
        comboBox.getItems().clear();
        comboBox.getItems().addAll(systemPorts);
    }

    /**
     * 点击BaudRateBox,显示可供选择的波特率
     */
    public void onShowBaudRateBox(Event event) {
        BaudRateBox.getItems().addAll(2400, 4800, 9600, 19200, 38400, 57600, 115200, 1000000);
        BaudRateBox.setVisibleRowCount(4);
    }

    /**
     * 打开串口
     */
    public void onActionOpenBtn(ActionEvent actionEvent) {
        isOpen = !isOpen;
        if (isOpen) {
            if (!serialController.open(comboBox.getValue(), BaudRateBox.getValue())) {
                return;
            }
            
            // lamba函数监听器
            serialController.setListenerToSerialPort(ev -&gt; {
                if (ev.getEventType() == SerialPortEvent.DATA_AVAILABLE) {
                    String newStr = &quot;&quot;;
                    try {
                        newStr = serialController.readData();
                    } catch (UnsupportedEncodingException e) {
                        e.printStackTrace();
                    }
                    System.out.println(newStr);

                    String finalNewStr = newStr;
                    Platform.runLater(() -&gt; {
                            receiveText.setText(finalNewStr);
                        }

                    );
                }
        });
            openBnt.setText(&quot;关闭串口&quot;);
        } else {
            serialController.close();
            openBnt.setText(&quot;打开串口&quot;);
        }

    }

    /**
     * 
     * @param actionEvent 发送的时间
     */
    public void onActionSendBtn(ActionEvent actionEvent) {
        serialController.sendData(sendText.getText());

        // 更新统计
        String newStr = cnt.getText();
        int sendCnt = 0;

        String re= &quot;[:].*[|]&quot;;
        Matcher matcher = Pattern.compile(re).matcher(newStr);
        if (matcher.find()) {
            sendCnt = Integer.parseInt(matcher.group().replace(&quot;:&quot;,&quot;&quot;).replace(&quot;|&quot;,&quot;&quot;));
        }
        sendCnt += sendText.getLength();

        newStr = &quot;发送:&quot; + Integer.toString(sendCnt) + '|' + newStr.substring(matcher.end());
        cnt.setText(newStr);
    }

    /**
     * 清除接收框
     */
    public void clear(ActionEvent actionEvent) {
        receiveText.clear();
    }
}

</code></pre>
<p>接下来启动就可以了</p>
<pre><code class="language-java">import javafx.application.Application;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.image.Image;
import javafx.stage.Stage;

import java.io.IOException;

public class Main extends Application {
    public static void main(String[] args) {
        launch(args);
    }

    @Override
    public void start(Stage primaryStage) {
        Parent root = null;
        try {
            root = FXMLLoader.load(getClass().getResource(&quot;SerialAssistant.fxml&quot;));
            primaryStage.setTitle(&quot;串口调试助手 李杰相 计科20-3&quot;);
            primaryStage.getIcons().add(new Image(&quot;avator.jpg&quot;));
            primaryStage.setScene(new Scene(root));
            primaryStage.show();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>关于代码架构，RXTXcomm已经内置了多线程，我再做多线程已经意义不大了。</p>
<p>RXTXcomm提供接收消息，渲染到GUI，GUI如果要发送消息，则通过输入输出流输出。</p>

                </div>
                
                    
                      <div class="next-post">
                        <div class="next">下一篇</div>
                        <a href="https://sethome2.github.io/post/di-shi-san-jie-lan-qiao-bei-cc-b-zu-ge-ren-bi-sai-ti-jiao-dai-ma-bai-lan-bei/">
                          <h3 class="post-title">
                            第十三届蓝桥杯C/C++ B组个人比赛提交代码（摆烂杯
                          </h3>
                        </a>
                      </div>
                      

                        
                          
                            <div id="gitalk-container" data-aos="fade-in"></div>
                            

                              
                                  

          </div>

        </div>
      </div>
  </div>

  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>




  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: 'a66037dc805d2519c1e3',
        clientSecret: '77cbde8229074e52566ea21d48e65a0e3f4e542c',
        repo: 'comment-website',
        owner: 'sethome2',
        admin: ['sethome2'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




</body>

</html>